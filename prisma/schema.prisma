// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model User {
  id           String   @id @default(uuid())
  email        String   @unique
  phone        String   @unique
  passwordHash String
  role         String   @default("USER") // USER | MERCHANT | ADMIN
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  merchant     Merchant?
  orders       Order[]
  bookings     ServiceBooking[]
  requests     ServiceRequest[]

  @@index([role])
  @@index([createdAt])
}

model ProductNameMapping {
  id              String   @id @default(uuid())
  shopifyProductId String  @unique // Shopify 商品ID
  shopifyVariantId String? // Shopify 变体ID（可选）
  englishName     String   // Shopify 英文名称
  chineseName     String   // 中文名称
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([shopifyProductId])
}

model Package {
  id          String   @id @default(uuid())
  name        String   // 套餐名称
  description String? // 套餐描述
  originalPrice String? // 原价（用于显示优惠）
  price       String   // 团购价
  itemsJson   String   // JSON string of items array (商品列表，包含shopifyProductId和shopifyVariantId)
  deliveryDatesJson String? // JSON string of delivery dates array (可选送货日期列表)
  region      String?  // 大区：中区、西区、北岸、东区
  imageUrl    String? // 套餐图片URL
  isActive    Boolean  @default(true) // 是否启用
  sortOrder   Int      @default(0) // 排序顺序
  merchantId  String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  merchant    Merchant? @relation(fields: [merchantId], references: [id], onDelete: SetNull)

  @@index([isActive])
  @@index([sortOrder])
  @@index([region])
  @@index([merchantId])
}

model Order {
  id                    String   @id @default(uuid())
  customerName          String
  phone                 String
  address               String
  deliveryTime          String
  itemsJson             String   // JSON string of items array (套餐信息)
  packageId             String?  // 关联的套餐ID（可选，用于历史记录）
  region                String?  // 大区：中区、西区、北岸、东区（从套餐继承或手动设置）
  paymentMethod         String   @default("transfer") // 支付方式: "transfer" 或 "cash_on_delivery"
  paymentScreenshotPath String?
  shopifyOrderId        String?
  internalStatus        String   @default("new")
  optionalNote          String?
  userId                String?
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  user                  User?    @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([internalStatus])
  @@index([createdAt])
  @@index([phone])
  @@index([packageId])
  @@index([region])
  @@index([deliveryTime])
  @@index([userId])
}

// -------------------------
// Phase 2: Service Booking
// -------------------------
model Service {
  id            String   @id @default(uuid())
  name          String
  description   String?
  price         String?  // Optional display price (kept as string for consistency with Package)
  durationMins  Int?     // Optional duration for scheduling
  timeSlotsJson String?  // JSON string of available time slots (e.g. ["2026-02-01 10:00", ...])
  imageUrl      String?
  isActive      Boolean  @default(true)
  sortOrder     Int      @default(0)
  merchantId    String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  bookings      ServiceBooking[]
  merchant      Merchant? @relation(fields: [merchantId], references: [id], onDelete: SetNull)

  @@index([isActive])
  @@index([sortOrder])
  @@index([createdAt])
  @@index([merchantId])
}

model ServiceBooking {
  id                 String   @id @default(uuid())
  serviceId           String
  customerName        String
  phone              String
  preferredTime      String   // Chosen slot or free-text time
  status             String   @default("new") // new/confirmed/completed/cancelled
  referenceImagePath String?
  optionalNote       String?
  userId             String?
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  service            Service  @relation(fields: [serviceId], references: [id], onDelete: Cascade)
  user               User?    @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([serviceId])
  @@index([phone])
  @@index([status])
  @@index([createdAt])
  @@index([userId])
}

// -----------------------------------------
// Phase 2 (Extension): Custom Service Request
// -----------------------------------------
model Merchant {
  id            String   @id @default(uuid())
  name          String
  contactName   String?
  phone         String?
  wechat        String?
  email         String?
  dashboardKey  String   @unique // simple access key for merchant dashboard (Phase 2 placeholder auth)
  isActive      Boolean  @default(true)
  userId        String?  @unique
  description   String?
  address       String?
  openHours     String?  // e.g. "Mon-Fri 09:00-18:00"
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  quotes        MerchantQuote[]
  packages      Package[]
  services      Service[]
  user          User?    @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([isActive])
  @@index([createdAt])
}

model ServiceRequest {
  id               String   @id @default(uuid())
  serviceType      String   // e.g. "Home Cleaning", "Moving Help"
  title            String?
  description      String
  address          String?
  preferredTime    String?  // free text for user preference
  referenceImagePath String?
  status           String   @default("open") // open/selected/closed
  userName         String
  userPhone        String
  userToken        String?  @unique // legacy access token for user-only view (Phase 2 placeholder auth)
  userId           String?
  selectedQuoteId  String?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  quotes           MerchantQuote[]
  selectedQuote    MerchantQuote? @relation("SelectedQuote", fields: [selectedQuoteId], references: [id])
  user             User?    @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([status])
  @@index([createdAt])
  @@index([userPhone])
  @@index([userId])
}

model MerchantQuote {
  id              String   @id @default(uuid())
  serviceRequestId String
  merchantId      String
  price           String   // quoted price
  details         String?  // scope / conditions
  contactInfo     String?  // snapshot contact info provided with this quote (optional)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  serviceRequest  ServiceRequest @relation(fields: [serviceRequestId], references: [id], onDelete: Cascade)
  merchant        Merchant       @relation(fields: [merchantId], references: [id], onDelete: Cascade)
  selectedBy      ServiceRequest[] @relation("SelectedQuote")

  @@unique([serviceRequestId, merchantId])
  @@index([serviceRequestId])
  @@index([merchantId])
  @@index([createdAt])
}
