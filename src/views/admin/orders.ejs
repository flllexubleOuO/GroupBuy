<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è®¢å•ç®¡ç†</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <style>
        [x-cloak] { display: none !important; }
    </style>
</head>
<body class="bg-gray-50">
    <div x-data="orderList()" x-cloak>
        <!-- Header -->
        <div class="bg-white shadow-sm mb-6">
            <div class="max-w-7xl mx-auto px-4 py-4 flex justify-between items-center">
                <div class="flex items-center space-x-4">
                    <a href="/admin/packages" class="text-blue-600 hover:text-blue-900">å¥—é¤ç®¡ç†</a>
                    <h1 class="text-2xl font-bold text-gray-900">è®¢å•ç®¡ç†</h1>
                </div>
                <form method="POST" action="/admin/logout" class="inline">
                    <button type="submit" class="text-gray-600 hover:text-gray-900">é€€å‡ºç™»å½•</button>
                </form>
            </div>
        </div>

        <!-- Filters -->
        <div class="max-w-7xl mx-auto px-4 mb-6">
            <div class="bg-white rounded-lg shadow-sm p-4">
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">è®¢å•çŠ¶æ€</label>
                        <select x-model="filters.status" @change="loadOrders()" 
                                class="w-full px-4 py-2 border rounded-lg">
                            <option value="all">å…¨éƒ¨</option>
                            <option value="new">æ–°è®¢å•</option>
                            <option value="paid_confirmed">å·²ç¡®è®¤ä»˜æ¬¾</option>
                            <option value="preparing">å¤‡è´§ä¸­</option>
                            <option value="delivering">æ´¾é€ä¸­</option>
                            <option value="completed">å·²å®Œæˆ</option>
                            <option value="cancelled">å·²å–æ¶ˆ</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">å¤§åŒº</label>
                        <select x-model="filters.region" @change="loadOrders()" 
                                class="w-full px-4 py-2 border rounded-lg">
                            <option value="">å…¨éƒ¨</option>
                            <option value="ä¸­åŒº">ä¸­åŒº</option>
                            <option value="è¥¿åŒº">è¥¿åŒº</option>
                            <option value="åŒ—å²¸">åŒ—å²¸</option>
                            <option value="ä¸œåŒº">ä¸œåŒº</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">é…é€æ—¥æœŸ</label>
                        <input type="date" x-model="filters.deliveryDate" @change="loadOrders()"
                               class="w-full px-4 py-2 border rounded-lg">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">æ‰‹æœºå·æœç´¢</label>
                        <input type="text" x-model="filters.phone" @input.debounce.500ms="loadOrders()"
                               placeholder="è¾“å…¥æ‰‹æœºå·"
                               class="w-full px-4 py-2 border rounded-lg">
                    </div>
                </div>
                <div class="mt-4 flex items-center space-x-4">
                    <button @click="loadOrders()" 
                            class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700">
                        æœç´¢
                    </button>
                    <button @click="openRoutePlanning()" 
                            :disabled="!canPlanRoute"
                            class="bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700 disabled:bg-gray-400 disabled:cursor-not-allowed">
                        è·¯çº¿è§„åˆ’
                    </button>
                </div>
            </div>
        </div>

        <!-- Loading -->
        <div x-show="loading" class="text-center py-12">
            <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"></div>
        </div>

        <!-- Orders Table -->
        <div x-show="!loading" class="max-w-7xl mx-auto px-4">
            <div class="bg-white rounded-lg shadow-sm overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">è®¢å•ID</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">å®¢æˆ·å§“å</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">æ‰‹æœºå·</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">åœ°å€</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">å¤§åŒº</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">é…é€æ—¶é—´</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">çŠ¶æ€</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Shopifyè®¢å•</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">åˆ›å»ºæ—¶é—´</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            <template x-for="order in orders" :key="order.id">
                                <tr class="hover:bg-gray-50">
                                    <td class="px-6 py-4 whitespace-nowrap text-sm font-mono text-gray-900" x-text="order.id.substring(0, 8)"></td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900" x-text="order.customerName"></td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900" x-text="order.phone"></td>
                                    <td class="px-6 py-4 text-sm text-gray-500 max-w-xs truncate" x-text="order.address"></td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm">
                                        <span x-show="order.region" 
                                              class="px-2 py-1 text-xs font-semibold rounded-full bg-blue-100 text-blue-800"
                                              x-text="order.region"></span>
                                        <span x-show="!order.region" class="text-gray-400">-</span>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900" x-text="order.deliveryTime"></td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <span class="px-2 py-1 text-xs font-semibold rounded-full" 
                                              :class="getStatusClass(order.internalStatus)"
                                              x-text="getStatusText(order.internalStatus)"></span>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm">
                                        <template x-if="order.shopifyOrderId">
                                            <a :href="'https://rhrw1p-nb.myshopify.com/admin/orders/' + order.shopifyOrderId" 
                                               target="_blank"
                                               class="text-blue-600 hover:underline" 
                                               x-text="order.shopifyOrderId"></a>
                                        </template>
                                        <span x-show="!order.shopifyOrderId" class="text-gray-400">-</span>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500" x-text="formatDate(order.createdAt)"></td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm">
                                        <div class="flex items-center space-x-3">
                                            <a :href="'/admin/orders/' + order.id" 
                                               class="text-blue-600 hover:text-blue-900">æŸ¥çœ‹è¯¦æƒ…</a>
                                            <button @click="deleteOrder(order)" 
                                                    class="text-red-600 hover:text-red-900">
                                                åˆ é™¤
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            </template>
                        </tbody>
                    </table>
                </div>

                <!-- Pagination -->
                <div x-show="pagination.totalPages > 1" class="bg-gray-50 px-6 py-4 flex items-center justify-between">
                    <div class="text-sm text-gray-700">
                        å…± <span x-text="pagination.total"></span> æ¡ï¼Œç¬¬ <span x-text="pagination.page"></span> / <span x-text="pagination.totalPages"></span> é¡µ
                    </div>
                    <div class="flex space-x-2">
                        <button @click="changePage(pagination.page - 1)" 
                                :disabled="pagination.page === 1"
                                class="px-4 py-2 border rounded-lg disabled:opacity-50 disabled:cursor-not-allowed">
                            ä¸Šä¸€é¡µ
                        </button>
                        <button @click="changePage(pagination.page + 1)" 
                                :disabled="pagination.page >= pagination.totalPages"
                                class="px-4 py-2 border rounded-lg disabled:opacity-50 disabled:cursor-not-allowed">
                            ä¸‹ä¸€é¡µ
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Route Planning Modal -->
        <div x-show="showRouteModal" 
             @click.self="closeRouteModal()"
             x-transition
             class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4"
             style="display: none;">
            <div @click.stop class="bg-white rounded-lg shadow-xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
                <div class="p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-bold text-gray-900">è·¯çº¿è§„åˆ’</h2>
                        <button @click="closeRouteModal()" class="text-gray-400 hover:text-gray-600 text-2xl">Ã—</button>
                    </div>
                    
                    <div class="mb-4 p-4 bg-blue-50 rounded-lg">
                        <p class="text-sm text-gray-700">
                            <strong>å¤§åŒºï¼š</strong><span x-text="filters.region"></span> | 
                            <strong>é…é€æ—¥æœŸï¼š</strong><span x-text="filters.deliveryDate"></span> | 
                            <strong>è®¢å•æ•°é‡ï¼š</strong><span x-text="routeOrders.length"></span>
                        </p>
                    </div>

                    <div class="mb-4 space-y-2">
                        <button @click="generateGoogleMapsRoute()" 
                                class="w-full bg-green-600 text-white px-6 py-3 rounded-lg hover:bg-green-700 font-semibold">
                            åœ¨ Google Maps ä¸­æ‰“å¼€è·¯çº¿è§„åˆ’
                        </button>
                        <p class="text-xs text-gray-500 text-center">
                            ğŸ’¡ æç¤ºï¼šå½“å‰è·¯å¾„æŒ‰è®¢å•é¡ºåºæ’åˆ—ï¼ŒGoogle Maps ä¼šå°½é‡ä¼˜åŒ–ï¼Œä½†å¯èƒ½ä¸æ˜¯ç»å¯¹æœ€ä¼˜ã€‚å¦‚éœ€æ›´ç²¾ç¡®ä¼˜åŒ–ï¼Œå»ºè®®åœ¨ Google Maps ä¸­æ‰‹åŠ¨è°ƒæ•´é¡ºåºã€‚
                        </p>
                    </div>

                    <div class="space-y-2">
                        <template x-for="(order, index) in routeOrders" :key="order.id">
                            <div class="border rounded-lg p-3 hover:bg-gray-50">
                                <div class="flex items-start justify-between">
                                    <div class="flex-1">
                                        <div class="flex items-center space-x-2 mb-1">
                                            <span class="text-sm font-semibold text-gray-900" x-text="'#' + (index + 1)"></span>
                                            <span class="text-sm font-medium text-gray-900" x-text="order.customerName"></span>
                                            <span class="text-sm text-gray-600" x-text="order.phone"></span>
                                        </div>
                                        <p class="text-sm text-gray-700" x-text="order.address"></p>
                                    </div>
                                    <a :href="'https://www.google.com/maps/search/?api=1&query=' + encodeURIComponent(order.address)"
                                       target="_blank"
                                       class="ml-4 text-blue-600 hover:text-blue-900 text-sm whitespace-nowrap">
                                        åœ¨åœ°å›¾ä¸­æŸ¥çœ‹
                                    </a>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        function orderList() {
            return {
                loading: true,
                orders: [],
                filters: {
                    status: '<%= status || "all" %>',
                    region: '',
                    deliveryDate: '',
                    phone: '<%= phone || "" %>',
                },
                showRouteModal: false,
                routeOrders: [],
                pagination: {
                    page: 1,
                    limit: 20,
                    total: 0,
                    totalPages: 0,
                },

                async init() {
                    await this.loadOrders();
                },

                async loadOrders() {
                    this.loading = true;
                    try {
                        const params = new URLSearchParams();
                        if (this.filters.status !== 'all') params.append('status', this.filters.status);
                        if (this.filters.region) params.append('region', this.filters.region);
                        if (this.filters.deliveryDate) params.append('deliveryDate', this.filters.deliveryDate);
                        if (this.filters.phone) params.append('phone', this.filters.phone);
                        params.append('page', this.pagination.page);
                        params.append('limit', this.pagination.limit);

                        const response = await fetch(`/admin/api/orders?${params}`);
                        const data = await response.json();

                        if (data.error) {
                            alert(data.error);
                        } else {
                            this.orders = data.orders || [];
                            this.pagination = data.pagination || this.pagination;
                        }
                    } catch (err) {
                        console.error(err);
                        alert('åŠ è½½è®¢å•å¤±è´¥');
                    } finally {
                        this.loading = false;
                    }
                },

                changePage(page) {
                    if (page >= 1 && page <= this.pagination.totalPages) {
                        this.pagination.page = page;
                        this.loadOrders();
                    }
                },

                getStatusText(status) {
                    const statusMap = {
                        'new': 'æ–°è®¢å•',
                        'paid_confirmed': 'å·²ç¡®è®¤ä»˜æ¬¾',
                        'preparing': 'å¤‡è´§ä¸­',
                        'delivering': 'æ´¾é€ä¸­',
                        'completed': 'å·²å®Œæˆ',
                        'cancelled': 'å·²å–æ¶ˆ',
                    };
                    return statusMap[status] || status;
                },

                getStatusClass(status) {
                    const classMap = {
                        'new': 'bg-yellow-100 text-yellow-800',
                        'paid_confirmed': 'bg-blue-100 text-blue-800',
                        'preparing': 'bg-purple-100 text-purple-800',
                        'delivering': 'bg-indigo-100 text-indigo-800',
                        'completed': 'bg-green-100 text-green-800',
                        'cancelled': 'bg-red-100 text-red-800',
                    };
                    return classMap[status] || 'bg-gray-100 text-gray-800';
                },

                formatDate(dateString) {
                    const date = new Date(dateString);
                    return date.toLocaleString('zh-CN');
                },

                get canPlanRoute() {
                    // æ£€æŸ¥æ˜¯å¦æœ‰ç­›é€‰æ¡ä»¶ï¼šå¤§åŒºå’Œé…é€æ—¥æœŸï¼Œå¹¶ä¸”æœ‰è®¢å•
                    return !!(this.filters.region && this.filters.deliveryDate && this.orders.length > 0);
                },

                openRoutePlanning() {
                    console.log('openRoutePlanning called', {
                        canPlanRoute: this.canPlanRoute,
                        region: this.filters.region,
                        deliveryDate: this.filters.deliveryDate,
                        ordersLength: this.orders.length
                    });
                    
                    if (!this.canPlanRoute) {
                        alert('è¯·å…ˆé€‰æ‹©å¤§åŒºå’Œé…é€æ—¥æœŸè¿›è¡Œç­›é€‰');
                        return;
                    }
                    
                    // æ”¶é›†å½“å‰ç­›é€‰ç»“æœä¸­çš„è®¢å•ï¼ˆå·²ç»æ˜¯ç­›é€‰åçš„ç»“æœï¼‰
                    // å†æ¬¡è¿‡æ»¤ç¡®ä¿å¤§åŒºå’Œæ—¥æœŸåŒ¹é…
                    this.routeOrders = this.orders.filter(order => {
                        const regionMatch = !this.filters.region || order.region === this.filters.region;
                        const dateMatch = !this.filters.deliveryDate || 
                            (order.deliveryTime && order.deliveryTime.includes(this.filters.deliveryDate));
                        return regionMatch && dateMatch;
                    });
                    
                    console.log('Filtered routeOrders:', this.routeOrders);
                    
                    if (this.routeOrders.length === 0) {
                        alert('æ²¡æœ‰ç¬¦åˆæ¡ä»¶çš„è®¢å•');
                        return;
                    }
                    
                    this.showRouteModal = true;
                    console.log('Modal should be shown, showRouteModal:', this.showRouteModal);
                },

                closeRouteModal() {
                    this.showRouteModal = false;
                    this.routeOrders = [];
                },

                generateGoogleMapsRoute() {
                    if (this.routeOrders.length === 0) return;
                    
                    // å›ºå®šçš„èµ·å§‹ç‚¹åœ°å€
                    const startAddress = '22 Moselle Avenue, Henderson, Auckland 0610';
                    const origin = encodeURIComponent(startAddress);
                    
                    // æ„å»º Google Maps è·¯çº¿è§„åˆ’ URL
                    // ä½¿ç”¨å›ºå®šçš„èµ·å§‹ç‚¹ï¼Œæ‰€æœ‰è®¢å•åœ°å€ä½œä¸ºé€”ç»ç‚¹æˆ–ç»ˆç‚¹
                    if (this.routeOrders.length === 1) {
                        // åªæœ‰ä¸€ä¸ªè®¢å•ï¼Œä»å›ºå®šèµ·ç‚¹å¯¼èˆªåˆ°è¯¥åœ°å€
                        const destination = encodeURIComponent(this.routeOrders[0].address);
                        const googleMapsUrl = `https://www.google.com/maps/dir/?api=1&origin=${origin}&destination=${destination}`;
                        window.open(googleMapsUrl, '_blank');
                    } else {
                        // å¤šä¸ªè®¢å•ï¼Œä½¿ç”¨ optimize:true å‚æ•°è®© Google Maps è‡ªåŠ¨ä¼˜åŒ–è·¯å¾„é¡ºåº
                        // æ³¨æ„ï¼šGoogle Maps Web URL ä¸æ”¯æŒ optimize å‚æ•°ï¼Œä½†ä¼šå°½é‡ä¼˜åŒ–
                        // æ‰€æœ‰è®¢å•åœ°å€ä½œä¸ºé€”ç»ç‚¹ï¼Œèµ·ç‚¹å’Œç»ˆç‚¹å›ºå®š
                        const waypoints = this.routeOrders
                            .map(order => encodeURIComponent(order.address))
                            .join('|');
                        
                        // ä½¿ç”¨ optimize:true å‚æ•°ï¼ˆè™½ç„¶ Web URL ä¸å®Œå…¨æ”¯æŒï¼Œä½† Google Maps ä¼šå°½é‡ä¼˜åŒ–ï¼‰
                        // æ›´å¥½çš„æ–¹æ¡ˆæ˜¯ä½¿ç”¨ Directions APIï¼Œä½†éœ€è¦ API Key
                        // è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨æ‰€æœ‰åœ°å€ä½œä¸º waypointsï¼Œè®© Google Maps è‡ªåŠ¨ä¼˜åŒ–é¡ºåº
                        const googleMapsUrl = `https://www.google.com/maps/dir/?api=1&origin=${origin}&destination=${origin}&waypoints=${waypoints}`;
                        window.open(googleMapsUrl, '_blank');
                    }
                },

                async deleteOrder(order) {
                    const message = order.shopifyOrderId
                        ? `ç¡®å®šè¦åˆ é™¤è®¢å• ${order.id.substring(0, 8)} å—ï¼Ÿ\n\næ­¤æ“ä½œå°†åŒæ—¶åˆ é™¤ï¼š\n- æœ¬åœ°è®¢å•è®°å½•\n- Shopifyè®¢å• ${order.shopifyOrderId}\n\næ­¤æ“ä½œä¸å¯æ¢å¤ï¼`
                        : `ç¡®å®šè¦åˆ é™¤è®¢å• ${order.id.substring(0, 8)} å—ï¼Ÿ\n\næ­¤æ“ä½œå°†åˆ é™¤æœ¬åœ°è®¢å•è®°å½•ã€‚æ­¤æ“ä½œä¸å¯æ¢å¤ï¼`;
                    
                    if (!confirm(message)) {
                        return;
                    }

                    try {
                        const response = await fetch(`/admin/api/orders/${order.id}`, {
                            method: 'DELETE',
                        });

                        const data = await response.json();

                        if (data.error) {
                            alert(data.error);
                        } else {
                            alert('è®¢å•å·²åˆ é™¤');
                            await this.loadOrders();
                        }
                    } catch (err) {
                        console.error(err);
                        alert('åˆ é™¤è®¢å•å¤±è´¥');
                    }
                },
            };
        }
    </script>
</body>
</html>

