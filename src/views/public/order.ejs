<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= typeof shareTitle !== 'undefined' ? shareTitle : 'Group-buy Order' %></title>
    
    <!-- 基础 SEO -->
    <meta name="description" content="<%= typeof shareDescription !== 'undefined' ? shareDescription : 'Group-buy deals with fast delivery. Limited-time offers — place your order now!' %>">
    <meta name="keywords" content="group-buy, deals, delivery, shopping">
    
    <!-- Open Graph (Facebook, LinkedIn 等) -->
    <meta property="og:type" content="website">
    <meta property="og:title" content="<%= typeof shareTitle !== 'undefined' ? shareTitle : 'Group-buy Order' %>">
    <meta property="og:description" content="<%= typeof shareDescription !== 'undefined' ? shareDescription : 'Group-buy deals with fast delivery. Limited-time offers — place your order now!' %>">
    <meta property="og:url" content="<%= typeof shareUrl !== 'undefined' ? shareUrl : (typeof baseUrl !== 'undefined' ? baseUrl : 'http://16.176.25.194:3000') + '/order' %>">
    <meta property="og:image" content="<%= typeof shareImage !== 'undefined' ? shareImage : (typeof baseUrl !== 'undefined' ? baseUrl : 'http://16.176.25.194:3000') + '/images/share-card.png' %>">
    <meta property="og:image:width" content="1200">
    <meta property="og:image:height" content="630">
    <meta property="og:image:type" content="image/jpeg">
    <meta property="og:site_name" content="GroupBuy">
    <meta property="og:locale" content="en_US">
    
    <!-- 微信分享 (WeChat Open Graph) -->
    <meta itemprop="name" content="<%= typeof shareTitle !== 'undefined' ? shareTitle : 'Group-buy Order' %>">
    <meta itemprop="description" content="<%= typeof shareDescription !== 'undefined' ? shareDescription : 'Group-buy deals with fast delivery. Limited-time offers — place your order now!' %>">
    <meta itemprop="image" content="<%= typeof shareImage !== 'undefined' ? shareImage : (typeof baseUrl !== 'undefined' ? baseUrl : 'http://16.176.25.194:3000') + '/images/share-card.png' %>">
    
    <!-- 微信特定标签 -->
    <meta name="weixin:card" content="summary_large_image">
    <meta name="weixin:title" content="<%= typeof shareTitle !== 'undefined' ? shareTitle : 'Group-buy Order' %>">
    <meta name="weixin:description" content="<%= typeof shareDescription !== 'undefined' ? shareDescription : 'Group-buy deals with fast delivery. Limited-time offers — place your order now!' %>">
    <meta name="weixin:image" content="<%= typeof shareImage !== 'undefined' ? shareImage : (typeof baseUrl !== 'undefined' ? baseUrl : 'http://16.176.25.194:3000') + '/images/share-card.png' %>">
    
    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="<%= typeof shareTitle !== 'undefined' ? shareTitle : 'Group-buy Order' %>">
    <meta name="twitter:description" content="<%= typeof shareDescription !== 'undefined' ? shareDescription : 'Group-buy deals with fast delivery. Limited-time offers — place your order now!' %>">
    <meta name="twitter:image" content="<%= typeof shareImage !== 'undefined' ? shareImage : (typeof baseUrl !== 'undefined' ? baseUrl : 'http://16.176.25.194:3000') + '/images/share-card.png' %>">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <style>
        [x-cloak] { display: none !important; }
        
        /* 移动端优化 */
        @media (max-width: 640px) {
            body {
                font-size: 14px;
            }
            
            .max-w-2xl {
                max-width: 100%;
                padding-left: 0.75rem;
                padding-right: 0.75rem;
            }
            
            /* 套餐卡片移动端优化 */
            .package-card {
                padding: 1rem;
            }
            
            .package-card img {
                width: 60px;
                height: 60px;
            }
            
            /* 价格显示优化 */
            .price-section {
                font-size: 0.875rem;
            }
            
            /* 按钮优化 */
            button, input[type="submit"] {
                min-height: 44px; /* 触摸友好的按钮高度 */
            }
            
            /* 输入框优化 */
            input, textarea, select {
                font-size: 16px; /* 防止iOS自动缩放 */
                padding: 0.75rem;
            }
            
            /* 文件上传按钮优化 */
            input[type="file"] {
                padding: 0.5rem;
            }
            
            /* 总计区域优化 */
            .total-section {
                padding: 1rem;
                font-size: 1.125rem;
            }
            
            /* 商品列表优化 */
            .item-list {
                font-size: 0.8125rem;
                padding: 0.5rem;
            }
        }
    </style>
</head>
<body class="bg-gray-50">
    <div x-data="orderForm()" x-cloak class="min-h-screen pb-24 sm:pb-20">
        <!-- Toast -->
        <div x-show="toast.show" x-transition class="fixed top-4 right-4 z-50">
            <div class="rounded-xl shadow-lg border px-4 py-3 text-sm"
                 :class="toast.type === 'error' ? 'bg-red-50 border-red-200 text-red-800' : 'bg-green-50 border-green-200 text-green-800'">
                <span x-text="toast.message"></span>
            </div>
        </div>

        <!-- Header -->
        <div class="bg-white shadow-sm sticky top-0 z-10">
            <div class="max-w-2xl mx-auto px-4 py-3 sm:py-4">
                <div class="flex items-center justify-between">
                    <h1 class="text-xl sm:text-2xl font-bold text-gray-900">Group-buy Order</h1>
                    <div class="flex items-center gap-3">
                        <a href="/cart" class="text-blue-600 hover:text-blue-800 text-sm sm:text-base">Cart</a>
                        <a href="/query-order" class="text-blue-600 hover:text-blue-800 text-sm sm:text-base">My orders</a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="max-w-2xl mx-auto px-3 sm:px-4 py-4 sm:py-6">
            <!-- Loading State -->
            <div x-show="loading" class="text-center py-12">
                <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"></div>
                <p class="mt-4 text-gray-600">Loading packages...</p>
            </div>

            <!-- Error State -->
            <div x-show="error" class="bg-red-50 border border-red-200 rounded-lg p-4 mb-6">
                <p class="text-red-800" x-text="error"></p>
            </div>

            <!-- Order Form -->
            <form x-show="!loading && !error" @submit.prevent="goToCart" class="space-y-6">
                <!-- Packages Section -->
                <div class="bg-white rounded-lg shadow-sm p-4 sm:p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="text-lg sm:text-xl font-semibold">Select packages</h2>
                        <span class="text-sm text-gray-500" x-show="filteredPackages.length !== packages.length">
                            Showing <span x-text="filteredPackages.length"></span> / <span x-text="packages.length"></span>
                        </span>
                    </div>
                    
                    <!-- Filter Section -->
                    <div class="mb-4 p-3 bg-gray-50 rounded-lg space-y-3">
                        <!-- Search by Name -->
                        <div>
                            <input type="text" 
                                   x-model="filters.search"
                                   placeholder="Search packages..."
                                   class="w-full px-3 py-2 border rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        </div>
                        
                        <!-- Filter by Region -->
                        <div>
                            <select x-model="filters.region" 
                                    class="w-full px-3 py-2 border rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                <option value="">All regions</option>
                                <option value="Sydney CBD">Sydney CBD</option>
                                <option value="Inner West">Inner West</option>
                                <option value="North Shore">North Shore</option>
                                <option value="Eastern Suburbs">Eastern Suburbs</option>
                            </select>
                        </div>
                        
                        <!-- Filter by Price Range -->
                        <div class="grid grid-cols-2 gap-2">
                            <div>
                                <label class="block text-xs text-gray-600 mb-1">Min price</label>
                                <input type="number" 
                                       x-model.number="filters.minPrice"
                                       placeholder="Min"
                                       min="0"
                                       step="0.01"
                                       class="w-full px-3 py-2 border rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            </div>
                            <div>
                                <label class="block text-xs text-gray-600 mb-1">Max price</label>
                                <input type="number" 
                                       x-model.number="filters.maxPrice"
                                       placeholder="Max"
                                       min="0"
                                       step="0.01"
                                       class="w-full px-3 py-2 border rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            </div>
                        </div>
                        
                        <!-- Clear Filters Button -->
                        <button type="button" 
                                @click="clearFilters()"
                                x-show="hasActiveFilters"
                                class="w-full text-sm text-blue-600 hover:text-blue-800 py-1">
                            Clear filters
                        </button>
                    </div>
                    
                    <div class="space-y-4" x-show="filteredPackages.length > 0">
                        <template x-for="pkg in filteredPackages" :key="pkg.id">
                            <div class="border rounded-lg p-3 sm:p-4 hover:border-blue-500 transition-colors package-card">
                                <div class="flex-1 min-w-0">
                                        <div class="flex flex-col sm:flex-row sm:items-start sm:justify-between mb-2 gap-2">
                                            <div class="flex-1 min-w-0">
                                                <h3 class="font-semibold text-gray-900 text-base sm:text-lg break-words" x-text="pkg.name"></h3>
                                                <p class="text-xs sm:text-sm text-gray-600 mt-1 break-words" x-text="pkg.description || ''"></p>
                                            </div>
                                            <div class="text-left sm:text-right flex-shrink-0 price-section">
                                                <template x-if="pkg.originalPrice">
                                                    <div>
                                                        <p class="text-xs sm:text-sm text-gray-400 line-through" x-text="'Original: $' + parseFloat(pkg.originalPrice).toFixed(2)"></p>
                                                        <p class="text-lg sm:text-xl font-bold text-red-600" x-text="'Deal: $' + parseFloat(pkg.price).toFixed(2)"></p>
                                                        <p class="text-xs text-green-600" x-text="'Save: $' + (parseFloat(pkg.originalPrice) - parseFloat(pkg.price)).toFixed(2)"></p>
                                                    </div>
                                                </template>
                                                <template x-if="!pkg.originalPrice">
                                                    <p class="text-lg sm:text-xl font-bold text-blue-600" x-text="'$' + parseFloat(pkg.price).toFixed(2)"></p>
                                                </template>
                                            </div>
                                        </div>
                                        <div class="mb-3 item-list">
                                            <p class="text-xs text-gray-500 mb-2 font-medium">Items included:</p>
                                            <div class="space-y-2">
                                                <template x-for="item in pkg.items" :key="item.shopifyProductId + '-' + item.shopifyVariantId">
                                                    <div class="flex items-center gap-2 p-2 bg-gray-50 rounded border border-gray-200">
                                                        <!-- 商品图片 -->
                                                        <div class="flex-shrink-0" x-show="item.imageUrl">
                                                            <img :src="item.imageUrl" :alt="item.title" 
                                                                 class="w-12 h-12 sm:w-16 sm:h-16 object-cover rounded border border-gray-300">
                                                        </div>
                                                        <div class="flex-shrink-0" x-show="!item.imageUrl">
                                                            <div class="w-12 h-12 sm:w-16 sm:h-16 bg-gray-200 rounded border border-gray-300 flex items-center justify-center">
                                                                <span class="text-xs text-gray-400">No image</span>
                                                            </div>
                                                        </div>
                                                        <!-- 商品信息 -->
                                                        <div class="flex-1 min-w-0">
                                                            <p class="text-xs sm:text-sm font-medium text-gray-900 break-words" x-text="item.title"></p>
                                                            <p class="text-xs text-gray-500 mt-0.5" x-text="'Qty: ×' + item.quantity"></p>
                                                        </div>
                                                    </div>
                                                </template>
                                            </div>
                                        </div>
                                        <div class="flex items-center justify-between gap-2">
                                            <div class="flex items-center space-x-2">
                                                <button type="button" @click="decreaseQuantity(pkg.id)" 
                                                        class="w-10 h-10 sm:w-8 sm:h-8 rounded-full bg-gray-200 flex items-center justify-center text-gray-700 hover:bg-gray-300 active:bg-gray-400 touch-manipulation"
                                                        :disabled="getQuantity(pkg.id) === 0">
                                                    <span class="text-lg sm:text-base">-</span>
                                                </button>
                                                <input type="number" 
                                                       :value="getQuantity(pkg.id)"
                                                       @input="updateQuantity(pkg.id, $event.target.value)"
                                                       min="0"
                                                       class="w-16 sm:w-16 text-center border rounded px-2 py-1.5 sm:py-1 text-base"
                                                       readonly>
                                                <button type="button" @click="increaseQuantity(pkg.id)" 
                                                        class="w-10 h-10 sm:w-8 sm:h-8 rounded-full bg-blue-600 flex items-center justify-center text-white hover:bg-blue-700 active:bg-blue-800 touch-manipulation">
                                                    <span class="text-lg sm:text-base">+</span>
                                                </button>
                                            </div>
                                            <button type="button" @click="addToCart(pkg.id)"
                                                    class="text-xs sm:text-sm text-blue-600 hover:text-blue-800 px-2 py-1 border border-blue-300 rounded hover:bg-blue-50 transition-colors touch-manipulation">
                                                Add to cart
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </template>
                    </div>

                    <!-- Pagination -->
                    <div x-show="pagination.totalPages > 1" class="mt-6 flex items-center justify-center gap-3">
                        <button
                            type="button"
                            @click="prevPage()"
                            class="px-3 py-2 rounded-lg border text-sm"
                            :class="pagination.page <= 1 ? 'text-gray-400 bg-gray-50 cursor-not-allowed' : 'text-gray-700 hover:bg-gray-50'"
                            :disabled="pagination.page <= 1"
                        >
                            Prev
                        </button>
                        <div class="text-sm text-gray-600">
                            Page <span x-text="pagination.page"></span> / <span x-text="pagination.totalPages"></span>
                            <span class="text-gray-400">·</span>
                            <span x-text="pagination.total"></span> total
                        </div>
                        <button
                            type="button"
                            @click="nextPage()"
                            class="px-3 py-2 rounded-lg border text-sm"
                            :class="pagination.page >= pagination.totalPages ? 'text-gray-400 bg-gray-50 cursor-not-allowed' : 'text-gray-700 hover:bg-gray-50'"
                            :disabled="pagination.page >= pagination.totalPages"
                        >
                            Next
                        </button>
                    </div>
                    <div x-show="filteredPackages.length === 0 && packages.length > 0" class="text-center text-gray-500 py-8">
                        <p class="mb-2">No packages match your filters.</p>
                        <button type="button" @click="clearFilters()" class="text-blue-600 hover:text-blue-800 text-sm">
                            Clear filters
                        </button>
                    </div>
                    <div x-show="packages.length === 0 && !loading" class="text-center text-gray-500 py-8">
                        No packages available
                    </div>
                </div>

                <!-- Go to cart -->
                <button type="submit" 
                        :disabled="submitting || total === 0"
                        class="w-full bg-blue-600 text-white py-4 sm:py-4 rounded-lg font-semibold text-base sm:text-lg hover:bg-blue-700 active:bg-blue-800 disabled:bg-gray-400 disabled:cursor-not-allowed touch-manipulation shadow-lg">
                    <span x-show="!submitting">Go to cart</span>
                    <span x-show="submitting">Saving...</span>
                </button>
            </form>
        </div>
    </div>

    <script type="application/json" id="cartInitJson"><%- JSON.stringify((typeof cartItems !== 'undefined' && cartItems) ? cartItems : {}) %></script>

    <script>
        function orderForm() {
            return {
                loading: true,
                error: null,
                packages: [],
                pagination: { page: 1, limit: 12, total: 0, totalPages: 1 },
                selectedPackages: {},
                filters: {
                    search: '',
                    region: '',
                    minPrice: null,
                    maxPrice: null,
                },
                cartInit: {},
                submitting: false,
                toast: { show: false, message: '', type: 'success' },
                toastTimer: null,
                searchTimer: null,

                showToast(message, type = 'success') {
                    this.toast = { show: true, message, type };
                    if (this.toastTimer) clearTimeout(this.toastTimer);
                    this.toastTimer = setTimeout(() => { this.toast.show = false; }, 1800);
                },

                buildPackagesUrl(page) {
                    const params = new URLSearchParams();
                    params.set('page', String(page || 1));
                    params.set('limit', String(this.pagination.limit || 12));
                    if (this.filters.region) params.set('region', this.filters.region);
                    if (this.filters.search && this.filters.search.trim()) params.set('q', this.filters.search.trim());
                    return '/api/packages?' + params.toString();
                },

                async loadPackages(page = 1) {
                    try {
                        this.loading = true;
                        const response = await fetch(this.buildPackagesUrl(page));
                        const data = await response.json();
                        if (data.error) {
                            this.error = data.error;
                        } else {
                            this.packages = data.packages || [];
                            if (data.pagination) {
                                this.pagination = {
                                    page: data.pagination.page || page,
                                    limit: data.pagination.limit || this.pagination.limit,
                                    total: data.pagination.total || 0,
                                    totalPages: data.pagination.totalPages || 1,
                                };
                            } else {
                                this.pagination.page = page;
                            }
                        }

                        // Initialize quantities from session cart (if any)
                        try {
                            const el = document.getElementById('cartInitJson');
                            this.cartInit = el ? JSON.parse(el.textContent || '{}') : {};
                        } catch {
                            this.cartInit = {};
                        }
                        if (this.cartInit && typeof this.cartInit === 'object') this.selectedPackages = { ...this.cartInit };
                    } catch (err) {
                        this.error = 'Failed to load packages. Please refresh and try again.';
                        console.error(err);
                    } finally {
                        this.loading = false;
                    }
                },

                async init() {
                    // Initial load
                    await this.loadPackages(1);

                    // Server-side search / region filtering (debounced)
                    this.$watch('filters.search', () => {
                        if (this.searchTimer) clearTimeout(this.searchTimer);
                        this.searchTimer = setTimeout(() => {
                            this.loadPackages(1);
                        }, 250);
                    });
                    this.$watch('filters.region', () => {
                        this.loadPackages(1);
                    });
                },

                get filteredPackages() {
                    let filtered = [...this.packages];
                    
                    // 按价格范围筛选
                    if (this.filters.minPrice !== null && this.filters.minPrice !== '') {
                        filtered = filtered.filter(pkg => parseFloat(pkg.price) >= this.filters.minPrice);
                    }
                    if (this.filters.maxPrice !== null && this.filters.maxPrice !== '') {
                        filtered = filtered.filter(pkg => parseFloat(pkg.price) <= this.filters.maxPrice);
                    }
                    
                    return filtered;
                },

                get hasActiveFilters() {
                    return !!(this.filters.search || 
                             this.filters.region || 
                             (this.filters.minPrice !== null && this.filters.minPrice !== '') ||
                             (this.filters.maxPrice !== null && this.filters.maxPrice !== ''));
                },

                clearFilters() {
                    this.filters = {
                        search: '',
                        region: '',
                        minPrice: null,
                        maxPrice: null,
                    };
                    this.loadPackages(1);
                },

                async prevPage() {
                    if (this.pagination.page <= 1) return;
                    await this.loadPackages(this.pagination.page - 1);
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                },

                async nextPage() {
                    if (this.pagination.page >= this.pagination.totalPages) return;
                    await this.loadPackages(this.pagination.page + 1);
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                },

                getQuantity(packageId) {
                    return this.selectedPackages[packageId] || 0;
                },

                increaseQuantity(packageId) {
                    if (!this.selectedPackages[packageId]) {
                        this.selectedPackages[packageId] = 0;
                    }
                    this.selectedPackages[packageId]++;
                },

                decreaseQuantity(packageId) {
                    if (this.selectedPackages[packageId] > 0) {
                        this.selectedPackages[packageId]--;
                        if (this.selectedPackages[packageId] === 0) {
                            // keep 0 (not in cart) unless user clicks "Add to cart"
                        }
                    }
                },

                updateQuantity(packageId, value) {
                    const num = parseInt(value) || 0;
                    this.selectedPackages[packageId] = Math.max(0, num);
                },

                // Payment is handled in /payment

                get total() {
                    let total = 0;
                    for (const pkg of this.packages) {
                        const quantity = this.selectedPackages[pkg.id] || 0;
                        total += parseFloat(pkg.price) * quantity;
                    }
                    return total;
                },

                get originalTotal() {
                    let total = 0;
                    for (const pkg of this.packages) {
                        const quantity = this.selectedPackages[pkg.id] || 0;
                        if (pkg.originalPrice) {
                            total += parseFloat(pkg.originalPrice) * quantity;
                        }
                    }
                    return total;
                },

                getPackageImages(pkg) {
                    // 如果套餐有设置图片，返回空数组（前端会显示套餐图片）
                    if (pkg.imageUrl) {
                        return [];
                    }
                    // 否则收集所有商品的图片
                    const images = [];
                    if (pkg.items && Array.isArray(pkg.items)) {
                        pkg.items.forEach(item => {
                            if (item.imageUrl && !images.includes(item.imageUrl)) {
                                images.push(item.imageUrl);
                            }
                        });
                    }
                    return images;
                },

                // Share is replaced by "Add to cart"

                async goToCart() {
                    // Cart is only updated when user clicks "Add to cart".
                    // Here we just navigate to the cart page.
                    window.location.href = '/cart';
                },

                async addToCart(packageId) {
                    const qty = this.getQuantity(packageId);
                    const finalQty = qty > 0 ? qty : 1; // default add 1 if user didn't increase
                    this.selectedPackages[packageId] = finalQty;

                    try {
                        const resp = await fetch('/cart/item', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ packageId, qty: finalQty }),
                        });
                        if (!resp.ok) {
                            const data = await resp.json().catch(() => ({}));
                            this.showToast(data.error || 'Failed to add to cart.', 'error');
                            return;
                        }
                        this.showToast('Added to cart.');
                    } catch (e) {
                        console.error(e);
                        this.showToast('Failed to add to cart. Please check your network and try again.', 'error');
                    }
                },
            };
        }
    </script>
</body>
</html>
