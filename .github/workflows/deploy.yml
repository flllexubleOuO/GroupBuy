name: Deploy to EC2

on:
  workflow_dispatch: # ä»…æ‰‹åŠ¨è§¦å‘ï¼ˆåœ¨ GitHub Actions é¡µé¢ç‚¹å‡» "Run workflow" æŒ‰é’®ï¼‰

jobs:
  deploy:
    name: Deploy to EC2 Server
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.EC2_SSH_KEY }}

      - name: Add EC2 to known hosts
        run: |
          # åˆ›å»º .ssh ç›®å½•ï¼ˆä½¿ç”¨æ›´å…¼å®¹çš„æ–¹æ³•ï¼‰
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          # æ·»åŠ  EC2 ä¸»æœºåˆ° known_hosts
          # æ³¨æ„ï¼šå³ä½¿å¤±è´¥ä¹Ÿä¸å½±å“éƒ¨ç½²ï¼Œå› ä¸ºå·²ä½¿ç”¨ StrictHostKeyChecking=no
          ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts 2>/dev/null || true
          # è®¾ç½® known_hosts æƒé™
          if [ -f ~/.ssh/known_hosts ]; then
            chmod 600 ~/.ssh/known_hosts
          fi

      - name: Deploy to EC2
        env:
          EC2_HOST: ${{ secrets.EC2_HOST }}
          EC2_USER: ${{ secrets.EC2_USER }}
          EC2_DEPLOY_PATH: ${{ secrets.EC2_DEPLOY_PATH }}
        run: |
          echo "ğŸš€ å¼€å§‹éƒ¨ç½²åˆ° EC2..."
          
          # è®¾ç½®é»˜è®¤éƒ¨ç½²è·¯å¾„
          DEPLOY_PATH="${EC2_DEPLOY_PATH:-/home/ec2-user/tuangou-project}"
          
          # åˆ›å»ºéƒ¨ç½²è·¯å¾„ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
          ssh -o StrictHostKeyChecking=no ${EC2_USER}@${EC2_HOST} "mkdir -p ${DEPLOY_PATH}"
          
          # åŒæ­¥ä»£ç åˆ°æœåŠ¡å™¨ï¼ˆæ’é™¤ä¸éœ€è¦çš„æ–‡ä»¶ï¼‰
          echo "ğŸ“¦ åŒæ­¥ä»£ç åˆ°æœåŠ¡å™¨..."
          echo "âš ï¸  é‡è¦ï¼šç¡®ä¿ prisma/migrations ç›®å½•è¢«åŒæ­¥ï¼ˆç”¨äºæ•°æ®åº“è¿ç§»ï¼‰"
          rsync -avz --delete \
            --exclude 'node_modules' \
            --exclude '.git' \
            --exclude 'dist' \
            --exclude '*.db' \
            --exclude '*.db-journal' \
            --exclude 'logs' \
            --exclude 'public/uploads' \
            --exclude '.env' \
            --exclude '.DS_Store' \
            ./ ${EC2_USER}@${EC2_HOST}:${DEPLOY_PATH}/
          
          # éªŒè¯è¿ç§»æ–‡ä»¶æ˜¯å¦å·²åŒæ­¥
          echo "ğŸ” éªŒè¯è¿ç§»æ–‡ä»¶æ˜¯å¦å·²åŒæ­¥..."
          ssh -o StrictHostKeyChecking=no ${EC2_USER}@${EC2_HOST} << EOF
            cd ${DEPLOY_PATH}
            if [ -d "prisma/migrations" ]; then
              echo "âœ… è¿ç§»æ–‡ä»¶ç›®å½•å­˜åœ¨"
              echo "è¿ç§»æ–‡ä»¶åˆ—è¡¨:"
              ls -la prisma/migrations/ | head -10 || echo "è¿ç§»ç›®å½•ä¸ºç©º"
            else
              echo "âŒ è­¦å‘Šï¼šè¿ç§»æ–‡ä»¶ç›®å½•ä¸å­˜åœ¨ï¼"
            fi
          EOF
          
          # åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œéƒ¨ç½²è„šæœ¬
          echo "ğŸ”§ åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œéƒ¨ç½²..."
          ssh -o StrictHostKeyChecking=no ${EC2_USER}@${EC2_HOST} << EOF
            set -e
            cd ${DEPLOY_PATH}
            
            # æ£€æŸ¥å¹¶å®‰è£…å¿…è¦çš„è½¯ä»¶ï¼ˆå¦‚æœéœ€è¦ï¼‰
            echo "ğŸ” æ£€æŸ¥ç³»ç»Ÿä¾èµ–..."
            
            # æ£€æŸ¥ Node.js
            if ! command -v node &> /dev/null; then
              echo "âš ï¸  Node.js æœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£… Node.js"
              exit 1
            fi
            
            # æ£€æŸ¥ npm
            if ! command -v npm &> /dev/null; then
              echo "âš ï¸  npm æœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£… npm"
              exit 1
            fi
            
            # æ£€æŸ¥ PM2
            if ! command -v pm2 &> /dev/null; then
              echo "âš ï¸  PM2 æœªå®‰è£…ï¼Œæ­£åœ¨å®‰è£…..."
              sudo npm install -g pm2
            fi
            
            # é…ç½® PM2 å¼€æœºè‡ªå¯ï¼ˆå¦‚æœè¿˜æ²¡æœ‰é…ç½®ï¼‰
            if ! pm2 startup | grep -q "already setup"; then
              echo "âš™ï¸  é…ç½® PM2 å¼€æœºè‡ªå¯..."
              sudo env PATH=\$PATH:/usr/bin pm2 startup systemd -u \$(whoami) --hp \$(eval echo ~\$USER) || echo "PM2 å¼€æœºè‡ªå¯é…ç½®å¯èƒ½éœ€è¦æ‰‹åŠ¨æ‰§è¡Œ"
            fi
            
            # æ£€æŸ¥ npx (Prisma éœ€è¦)
            if ! command -v npx &> /dev/null; then
              echo "âš ï¸  npx æœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£… npm"
              exit 1
            fi
            
            echo "âœ… ç³»ç»Ÿä¾èµ–æ£€æŸ¥å®Œæˆ"
            echo "Node.js ç‰ˆæœ¬: \$(node --version)"
            echo "npm ç‰ˆæœ¬: \$(npm --version)"
            echo "PM2 ç‰ˆæœ¬: \$(pm2 --version)"
            
            # ç¡®ä¿å¿…è¦çš„ç›®å½•å­˜åœ¨
            echo "ğŸ“ åˆ›å»ºå¿…è¦çš„ç›®å½•..."
            mkdir -p prisma public/uploads logs
            chmod -R 755 public/uploads logs
            
            # ç¡®ä¿ deploy.sh æœ‰æ‰§è¡Œæƒé™
            chmod +x deploy.sh
            
            # æ‰§è¡Œéƒ¨ç½²è„šæœ¬
            ./deploy.sh
            
            echo "âœ… éƒ¨ç½²å®Œæˆï¼"
          EOF
          
          echo "ğŸ‰ éƒ¨ç½²æˆåŠŸï¼"

      - name: Verify Service Status
        if: success()
        env:
          EC2_HOST: ${{ secrets.EC2_HOST }}
          EC2_USER: ${{ secrets.EC2_USER }}
          EC2_DEPLOY_PATH: ${{ secrets.EC2_DEPLOY_PATH }}
        run: |
          DEPLOY_PATH="${EC2_DEPLOY_PATH:-/home/ec2-user/tuangou-project}"
          echo "ğŸ” éªŒè¯æœåŠ¡çŠ¶æ€..."
          
          # æ£€æŸ¥ PM2 è¿›ç¨‹çŠ¶æ€
          ssh -o StrictHostKeyChecking=no ${EC2_USER}@${EC2_HOST} << EOF
            cd ${DEPLOY_PATH}
            echo "ğŸ“Š PM2 è¿›ç¨‹çŠ¶æ€:"
            pm2 status
            
            echo ""
            echo "ğŸ“ æœ€è¿‘çš„åº”ç”¨æ—¥å¿—:"
            pm2 logs group-buy-system --lines 10 --nostream || echo "æ— æ³•è·å–æ—¥å¿—"
            
            echo ""
            echo "ğŸ”— åº”ç”¨ä¿¡æ¯:"
            pm2 info group-buy-system || echo "æ— æ³•è·å–åº”ç”¨ä¿¡æ¯"
          EOF
          
          echo ""
          echo "âœ… éƒ¨ç½²æˆåŠŸå®Œæˆï¼"
          echo "æœåŠ¡å™¨åœ°å€: ${{ secrets.EC2_HOST }}"
          echo "éƒ¨ç½²è·¯å¾„: ${DEPLOY_PATH}"
          echo "åº”ç”¨åº”è¯¥å¯ä»¥é€šè¿‡ http://${{ secrets.EC2_HOST }}:3000 è®¿é—®"

      - name: Deployment Failed
        if: failure()
        run: |
          echo "âŒ éƒ¨ç½²å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ—¥å¿—"
          exit 1

