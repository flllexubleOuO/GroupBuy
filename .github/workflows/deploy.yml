name: Deploy to EC2

on:
  push:
    branches:
      - main
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  deploy:
    name: Deploy to EC2 Server
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.EC2_SSH_KEY }}

      - name: Add EC2 to known hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy to EC2
        env:
          EC2_HOST: ${{ secrets.EC2_HOST }}
          EC2_USER: ${{ secrets.EC2_USER }}
          EC2_DEPLOY_PATH: ${{ secrets.EC2_DEPLOY_PATH }}
        run: |
          echo "ğŸš€ å¼€å§‹éƒ¨ç½²åˆ° EC2..."
          
          # è®¾ç½®é»˜è®¤éƒ¨ç½²è·¯å¾„
          DEPLOY_PATH="${EC2_DEPLOY_PATH:-/home/ec2-user/tuangou-project}"
          
          # åˆ›å»ºéƒ¨ç½²è·¯å¾„ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
          ssh -o StrictHostKeyChecking=no ${EC2_USER}@${EC2_HOST} "mkdir -p ${DEPLOY_PATH}"
          
          # åŒæ­¥ä»£ç åˆ°æœåŠ¡å™¨ï¼ˆæ’é™¤ä¸éœ€è¦çš„æ–‡ä»¶ï¼‰
          echo "ğŸ“¦ åŒæ­¥ä»£ç åˆ°æœåŠ¡å™¨..."
          rsync -avz --delete \
            --exclude 'node_modules' \
            --exclude '.git' \
            --exclude 'dist' \
            --exclude '*.db' \
            --exclude '*.db-journal' \
            --exclude 'logs' \
            --exclude 'public/uploads' \
            --exclude '.env' \
            --exclude '.DS_Store' \
            ./ ${EC2_USER}@${EC2_HOST}:${DEPLOY_PATH}/
          
          # åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œéƒ¨ç½²è„šæœ¬
          echo "ğŸ”§ åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œéƒ¨ç½²..."
          ssh -o StrictHostKeyChecking=no ${EC2_USER}@${EC2_HOST} << EOF
            set -e
            cd ${DEPLOY_PATH}
            
            # ç¡®ä¿ deploy.sh æœ‰æ‰§è¡Œæƒé™
            chmod +x deploy.sh
            
            # æ‰§è¡Œéƒ¨ç½²è„šæœ¬
            ./deploy.sh
            
            echo "âœ… éƒ¨ç½²å®Œæˆï¼"
          EOF
          
          echo "ğŸ‰ éƒ¨ç½²æˆåŠŸï¼"

      - name: Deployment Status
        if: success()
        env:
          EC2_DEPLOY_PATH: ${{ secrets.EC2_DEPLOY_PATH }}
        run: |
          DEPLOY_PATH="${EC2_DEPLOY_PATH:-/home/ec2-user/tuangou-project}"
          echo "âœ… éƒ¨ç½²æˆåŠŸå®Œæˆï¼"
          echo "æœåŠ¡å™¨åœ°å€: ${{ secrets.EC2_HOST }}"
          echo "éƒ¨ç½²è·¯å¾„: ${DEPLOY_PATH}"

      - name: Deployment Failed
        if: failure()
        run: |
          echo "âŒ éƒ¨ç½²å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ—¥å¿—"
          exit 1

