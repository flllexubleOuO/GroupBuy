name: Deploy to EC2

on:
  push:
    branches:
      - main
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  deploy:
    name: Deploy to EC2 Server
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.EC2_SSH_KEY }}

      - name: Add EC2 to known hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy to EC2
        env:
          EC2_HOST: ${{ secrets.EC2_HOST }}
          EC2_USER: ${{ secrets.EC2_USER }}
          EC2_DEPLOY_PATH: ${{ secrets.EC2_DEPLOY_PATH }}
        run: |
          echo "ğŸš€ å¼€å§‹éƒ¨ç½²åˆ° EC2..."
          
          # è®¾ç½®é»˜è®¤éƒ¨ç½²è·¯å¾„
          DEPLOY_PATH="${EC2_DEPLOY_PATH:-/home/ec2-user/tuangou-project}"
          
          # åˆ›å»ºéƒ¨ç½²è·¯å¾„ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
          ssh -o StrictHostKeyChecking=no ${EC2_USER}@${EC2_HOST} "mkdir -p ${DEPLOY_PATH}"
          
          # åŒæ­¥ä»£ç åˆ°æœåŠ¡å™¨ï¼ˆæ’é™¤ä¸éœ€è¦çš„æ–‡ä»¶ï¼‰
          echo "ğŸ“¦ åŒæ­¥ä»£ç åˆ°æœåŠ¡å™¨..."
          rsync -avz --delete \
            --exclude 'node_modules' \
            --exclude '.git' \
            --exclude 'dist' \
            --exclude '*.db' \
            --exclude '*.db-journal' \
            --exclude 'logs' \
            --exclude 'public/uploads' \
            --exclude '.env' \
            --exclude '.DS_Store' \
            ./ ${EC2_USER}@${EC2_HOST}:${DEPLOY_PATH}/
          
          # åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œéƒ¨ç½²è„šæœ¬
          echo "ğŸ”§ åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œéƒ¨ç½²..."
          ssh -o StrictHostKeyChecking=no ${EC2_USER}@${EC2_HOST} << EOF
            set -e
            cd ${DEPLOY_PATH}
            
            # æ£€æŸ¥å¹¶å®‰è£…å¿…è¦çš„è½¯ä»¶ï¼ˆå¦‚æœéœ€è¦ï¼‰
            echo "ğŸ” æ£€æŸ¥ç³»ç»Ÿä¾èµ–..."
            
            # æ£€æŸ¥ Node.js
            if ! command -v node &> /dev/null; then
              echo "âš ï¸  Node.js æœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£… Node.js"
              exit 1
            fi
            
            # æ£€æŸ¥ npm
            if ! command -v npm &> /dev/null; then
              echo "âš ï¸  npm æœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£… npm"
              exit 1
            fi
            
            # æ£€æŸ¥ PM2
            if ! command -v pm2 &> /dev/null; then
              echo "âš ï¸  PM2 æœªå®‰è£…ï¼Œæ­£åœ¨å®‰è£…..."
              sudo npm install -g pm2
            fi
            
            # æ£€æŸ¥ npx (Prisma éœ€è¦)
            if ! command -v npx &> /dev/null; then
              echo "âš ï¸  npx æœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£… npm"
              exit 1
            fi
            
            echo "âœ… ç³»ç»Ÿä¾èµ–æ£€æŸ¥å®Œæˆ"
            echo "Node.js ç‰ˆæœ¬: \$(node --version)"
            echo "npm ç‰ˆæœ¬: \$(npm --version)"
            echo "PM2 ç‰ˆæœ¬: \$(pm2 --version)"
            
            # ç¡®ä¿ deploy.sh æœ‰æ‰§è¡Œæƒé™
            chmod +x deploy.sh
            
            # æ‰§è¡Œéƒ¨ç½²è„šæœ¬
            ./deploy.sh
            
            echo "âœ… éƒ¨ç½²å®Œæˆï¼"
          EOF
          
          echo "ğŸ‰ éƒ¨ç½²æˆåŠŸï¼"

      - name: Deployment Status
        if: success()
        env:
          EC2_DEPLOY_PATH: ${{ secrets.EC2_DEPLOY_PATH }}
        run: |
          DEPLOY_PATH="${EC2_DEPLOY_PATH:-/home/ec2-user/tuangou-project}"
          echo "âœ… éƒ¨ç½²æˆåŠŸå®Œæˆï¼"
          echo "æœåŠ¡å™¨åœ°å€: ${{ secrets.EC2_HOST }}"
          echo "éƒ¨ç½²è·¯å¾„: ${DEPLOY_PATH}"

      - name: Deployment Failed
        if: failure()
        run: |
          echo "âŒ éƒ¨ç½²å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ—¥å¿—"
          exit 1

